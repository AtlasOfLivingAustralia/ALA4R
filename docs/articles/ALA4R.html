<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALA4R • ALA4R</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="ALA4R">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ALA4R</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.5.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ALA4R.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/AtlasOfLivingAustralia/ALA4R">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>ALA4R</h1>
                        <h4 class="author">Ben Raymond</h4>
            
            <h4 class="date">2018-05-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/AtlasOfLivingAustralia/ALA4R/blob/master/vignettes/ALA4R.Rmd"><code>vignettes/ALA4R.Rmd</code></a></small>
      <div class="hidden name"><code>ALA4R.Rmd</code></div>

    </div>

    
    
<div id="ala4r" class="section level1">
<h1 class="hasAnchor">
<a href="#ala4r" class="anchor"></a>ALA4R</h1>
<p>The Atlas of Living Australia (ALA) provides tools to enable users of biodiversity information to find, access, combine and visualise data on Australian plants and animals; these have been made available from <a href="http://www.ala.org.au/" class="uri">http://www.ala.org.au/</a>. Here we provide a subset of the tools to be directly used within R.</p>
<p>ALA4R enables the R community to directly access data and resources hosted by the ALA.</p>
<div id="installing-ala4r" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-ala4r" class="anchor"></a>Installing ALA4R</h2>
<div id="windows" class="section level3">
<h3 class="hasAnchor">
<a href="#windows" class="anchor"></a>Windows</h3>
<p>In R:</p>
<p>Stable version from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">"ALA4R"</span>)</a></code></pre></div>
<p>Or the development version from GitHub:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">"devtools"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"AtlasOfLivingAustralia/ALA4R"</span>)</a></code></pre></div>
<p>You may see a warning about the <code>Rtools</code> package: you don’t need to install this. You may also be asked about a location for the <code>R.cache</code> directory — choose whatever you prefer here, ALA4R does not use <code>R.cache</code>.</p>
<p>If you see an error about a missing package, you will need to install it manually, e.g.:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">"stringr"</span>,<span class="st">"sp"</span>))</a></code></pre></div>
<p>and then try installing ALA4R again.</p>
<p>If you wish to use the <code>data.table</code> package for potentially faster loading of data matrices (optional), also do:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">"data.table"</span>)</a></code></pre></div>
</div>
<div id="linux" class="section level3">
<h3 class="hasAnchor">
<a href="#linux" class="anchor"></a>Linux</h3>
<p>First, ensure that <code>libcurl</code> is installed on your system — e.g. on Ubuntu, open a terminal and do:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="fu">sudo</span> apt-get install libcurl4-openssl-dev</a></code></pre></div>
<p>or install <code>libcurl4-openssl-dev</code> via the Software Centre.</p>
<p>Then follow the instructions for Windows, above.</p>
</div>
</div>
<div id="using-ala4r" class="section level2">
<h2 class="hasAnchor">
<a href="#using-ala4r" class="anchor"></a>Using ALA4R</h2>
<p>The ALA4R package must be loaded for each new R session:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(ALA4R)</a></code></pre></div>
</div>
<div id="customizing" class="section level2">
<h2 class="hasAnchor">
<a href="#customizing" class="anchor"></a>Customizing</h2>
<p>Various aspects of the ALA4R package can be customized.</p>
<div id="caching" class="section level3">
<h3 class="hasAnchor">
<a href="#caching" class="anchor"></a>Caching</h3>
<p>ALA4R can cache most results to local files. This means that if the same code is run multiple times, the second and subsequent iterations will be faster. This will also reduce load on the ALA servers.</p>
<p>By default, this caching is session-based, meaning that the local files are stored in a temporary directory that is automatically deleted when the R session is ended. This behaviour can be altered so that caching is permanent, by setting the caching directory to a non-temporary location. For example, under Windows, use something like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(cache_directory &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"c:"</span>,<span class="st">"mydata"</span>,<span class="st">"ala_cache"</span>)) ## Windows</a></code></pre></div>
<p>or for Linux:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(cache_directory &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"~"</span>,<span class="st">"mydata"</span>,<span class="st">"ala_cache"</span>)) ## Linux</a></code></pre></div>
<p>Note that this directory must exist (you need to create it yourself).</p>
<p>All results will be stored in that cache directory and will be used from one session to the next. They won’t be re-downloaded from the server unless the user specifically deletes those files or changes the caching setting to “refresh”.</p>
<p>If you change the cache_directory to a permanent location, you may wish to add something like this to your .Rprofile file, so that it happens automatically each time the ALA4R package is loaded:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">setHook</span>(<span class="kw">packageEvent</span>(<span class="st">"ALA4R"</span>, <span class="st">"attach"</span>), <span class="cf">function</span>(...) <span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(<span class="dt">cache_directory=</span><span class="kw">file.path</span>(<span class="st">"~"</span>,<span class="st">"mydata"</span>,<span class="st">"ala_cache"</span>)))</a></code></pre></div>
<p>Caching can also be turned off entirely by:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(<span class="dt">caching=</span><span class="st">"off"</span>)</a></code></pre></div>
<p>or set to “refresh”, meaning that the cached results will re-downloaded from the ALA servers and the cache updated. (This will happen for as long as caching is set to “refresh” — so you may wish to switch back to normal “on” caching behaviour once you have updated your cache with the data you are working on).</p>
</div>
<div id="user-agent-string" class="section level3">
<h3 class="hasAnchor">
<a href="#user-agent-string" class="anchor"></a>User-agent string</h3>
<p>Each request to the ALA servers is accompanied by a “user-agent” string that identifies the software making the request. This is a standard behaviour used by web browsers as well. The user-agent identifies the user requests to the ALA, helping the ALA to adapt and enhance the services that it provides. By default, the ALA4R user-agent string is set to “ALA4R” plus the ALA4R version number (e.g. “ALA4R 1.5.2”).</p>
<p><em>NO</em> personal identification information is sent. You can see all configuration settings, including the the user-agent string that is being used, with the command:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>()</a></code></pre></div>
</div>
<div id="debugging" class="section level3">
<h3 class="hasAnchor">
<a href="#debugging" class="anchor"></a>Debugging</h3>
<p>If things aren’t working as expected, more detail (particularly about web requests and caching behaviour) can be obtained by setting the <code>verbose</code> configuration option:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(<span class="dt">verbose=</span><span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="setting-the-download-reason" class="section level3">
<h3 class="hasAnchor">
<a href="#setting-the-download-reason" class="anchor"></a>Setting the download reason</h3>
<p>ALA requires that you provide a reason when downloading occurrence data (via the ALA4R <code><a href="../reference/occurrences.html">occurrences()</a></code> function). You can provide this as a parameter directly to each call of <code><a href="../reference/occurrences.html">occurrences()</a></code>, or you can set it once per session using:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(<span class="dt">download_reason_id=</span>your_reason_id)</a></code></pre></div>
<p>(See <code><a href="../reference/ala_config.html">ala_reasons()</a></code> for valid download reasons)</p>
</div>
<div id="other-options" class="section level3">
<h3 class="hasAnchor">
<a href="#other-options" class="anchor"></a>Other options</h3>
<p>If you make a request that returns an empty result set (e.g. an un-matched name), by default you will simply get an empty data structure returned to you without any special notification. If you would like to be warned about empty result sets, you can use:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>(<span class="dt">warn_on_empty=</span><span class="ot">TRUE</span>)</a></code></pre></div>
</div>
</div>
<div id="example-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#example-usage" class="anchor"></a>Example usage</h2>
<p>First, check that we have some additional packages that we’ll use in the examples, and install them if necessary.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">to_install &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"plyr"</span>,<span class="st">"jpeg"</span>,<span class="st">"phytools"</span>,<span class="st">"ape"</span>,<span class="st">"vegan"</span>,<span class="st">"mgcv"</span>,<span class="st">"geosphere"</span>,<span class="st">"maps"</span>,<span class="st">"mapdata"</span>,<span class="st">"maptools"</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">to_install &lt;-<span class="st"> </span>to_install[<span class="op">!</span><span class="kw">sapply</span>(to_install,requireNamespace,<span class="dt">quietly=</span><span class="ot">TRUE</span>)]</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="cf">if</span>(<span class="kw">length</span>(to_install)<span class="op">&gt;</span><span class="dv">0</span>) <span class="kw">install.packages</span>(to_install,<span class="dt">repos=</span><span class="st">"http://cran.us.r-project.org"</span>)</a></code></pre></div>
<p>We’ll use the <code>plyr</code> package throughout these examples, so load that now:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">library</span>(plyr)</a></code></pre></div>
<div id="example-1-name-searching-and-taxonomic-trees" class="section level3">
<h3 class="hasAnchor">
<a href="#example-1-name-searching-and-taxonomic-trees" class="anchor"></a>Example 1: Name searching and taxonomic trees</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">library</span>(ape)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">library</span>(phytools)</a></code></pre></div>
<p>We want to look at the taxonomic tree of penguins, but we don’t know what the correct scientific name is, so let’s search for it:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">sx &lt;-<span class="st"> </span><span class="kw"><a href="../reference/search_fulltext.html">search_fulltext</a></span>(<span class="st">"penguins"</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">sx<span class="op">$</span>data[,<span class="kw">c</span>(<span class="st">"name"</span>,<span class="st">"rank"</span>,<span class="st">"commonName"</span>)]</a></code></pre></div>
<pre><code>##                       name    rank
## 1          SPHENISCIFORMES   order
## 2             SPHENISCIDAE  family
## 3       Pygoscelis adeliae species
## 4    Eudyptes chrysolophus species
## 5       Megadyptes waitaha species
## 6       Pygoscelis adeliae species
## 7  Spheniscus magellanicus species
## 8  Spheniscus magellanicus species
## 9        Ixodes eudyptidis species
## 10 Aptenodytes patagonicus species
##                                          commonName
## 1                                          Penguins
## 2                                          Penguins
## 3                    Adelie Penguin, Adélie Penguin
## 4  Macaroni Penguin, Royal Penguin, Crested Penguin
## 5                                   Waitaha Penguin
## 6                                    Adelie Penguin
## 7                                Magellanic Penguin
## 8                                Magellanic Penguin
## 9                                      Penguin Tick
## 10                                     King Penguin</code></pre>
<p>And we can see that penguins correspond to the family Spheniscidae. There are (at the time of writing this vignette) two results: one “Spheniscidae” and the other “SPHENISCIDAE” (identical except all upper case). The first comes from the New Zealand Organism Register and represents extinct penguins. We want the other one (“SPHENISCIDAE”). Now we can download the taxonomic data (note that the search is case-sensitive):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">tx &lt;-<span class="st"> </span><span class="kw"><a href="../reference/taxinfo_download.html">taxinfo_download</a></span>(<span class="st">"rk_family:SPHENISCIDAE"</span>,<span class="dt">fields=</span><span class="kw">c</span>(<span class="st">"guid"</span>,<span class="st">"rk_genus"</span>,<span class="st">"scientificName"</span>,<span class="st">"rank"</span>))</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">tx &lt;-<span class="st"> </span>tx[tx<span class="op">$</span>rank <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"species"</span>,<span class="st">"subspecies"</span>),] ## restrict to species and subspecies</a></code></pre></div>
<p>We can make a taxonomic tree plot using the <code>phytools</code> package:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">## as.phylo requires the taxonomic columns to be factors</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">temp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/colwise">colwise</a></span>(factor, <span class="kw">c</span>(<span class="st">"genus"</span>,<span class="st">"scientificName"</span>))(tx)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">## create phylo object of Scientific.Name nested within Genus</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">ax &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/as.phylo">as.phylo</a></span>(<span class="op">~</span>genus<span class="op">/</span>scientificName,<span class="dt">data=</span>temp)</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="kw"><a href="http://www.rdocumentation.org/packages/phytools/topics/plotTree">plotTree</a></span>(ax,<span class="dt">type=</span><span class="st">"fan"</span>,<span class="dt">fsize=</span><span class="fl">0.7</span>) ## plot it</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-20-1.png" width="576" style="display:block; margin: auto"></p>
<p>We can also plot the tree with images of the different penguin species. We’ll first extract a species profile for each species identifier (guid) in our results:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">s &lt;-<span class="st"> </span><span class="kw"><a href="../reference/search_guids.html">search_guids</a></span>(tx<span class="op">$</span>guid)</a></code></pre></div>
<p>And for each of those species profiles, download the thumbnail image and store it in our data cache:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">imfiles &lt;-<span class="st"> </span><span class="kw">sapply</span>(s<span class="op">$</span>thumbnailUrl,<span class="cf">function</span>(z){</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(z),ALA4R<span class="op">:::</span><span class="kw">cached_get</span>(z,<span class="dt">type=</span><span class="st">"binary_filename"</span>),<span class="st">""</span>)</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">})</a></code></pre></div>
<p>And finally, plot the tree:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/phytools/topics/plotTree">plotTree</a></span>(ax,<span class="dt">type=</span><span class="st">"fan"</span>,<span class="dt">ftype=</span><span class="st">"off"</span>) ## plot tree without labels</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">tr &lt;-<span class="st"> </span><span class="kw">get</span>(<span class="st">"last_plot.phylo"</span>,<span class="dt">envir =</span> .PlotPhyloEnv) ## get the tree plot object</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">## add each image</a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="kw">library</span>(jpeg)</a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="cf">for</span> (k <span class="cf">in</span> <span class="kw">which</span>(<span class="kw">nchar</span>(imfiles)<span class="op">&gt;</span><span class="dv">0</span>))</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">        <span class="kw">rasterImage</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/jpeg/topics/readJPEG">readJPEG</a></span>(imfiles[k]),tr<span class="op">$</span>xx[k]<span class="op">-</span><span class="dv">1</span><span class="op">/</span><span class="dv">10</span>,tr<span class="op">$</span>yy[k]<span class="op">-</span><span class="dv">1</span><span class="op">/</span><span class="dv">10</span>,tr<span class="op">$</span>xx[k]<span class="op">+</span><span class="dv">1</span><span class="op">/</span><span class="dv">10</span>,tr<span class="op">$</span>yy[k]<span class="op">+</span><span class="dv">1</span><span class="op">/</span><span class="dv">10</span>)</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-23-1.png" width="700" style="display:block; margin: auto"></p>
</div>
<div id="example-2-area-report-what-listed-species-exist-in-a-given-area" class="section level3">
<h3 class="hasAnchor">
<a href="#example-2-area-report-what-listed-species-exist-in-a-given-area" class="anchor"></a>Example 2: Area report: what listed species exist in a given area?</h3>
<p>First download an example shapefile of South Australian conservation reserve boundaries: see <a href="http://data.sa.gov.au/dataset/conservation-reserve-boundaries" class="uri">http://data.sa.gov.au/dataset/conservation-reserve-boundaries</a>. We use the ALA4R’s caching mechanism here, but you could equally download this file directly.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">library</span>(maptools)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">shape_filename &lt;-<span class="st"> </span>ALA4R<span class="op">:::</span><span class="kw">cached_get</span>(<span class="st">"https://data.environment.sa.gov.au/NatureMaps/Documents/CONSERVATION_Npwsa_Reserves_shp.zip"</span>, <span class="dt">type=</span><span class="st">"binary_filename"</span>)</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="kw">unzip</span>(shape_filename,<span class="dt">exdir=</span><span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>()<span class="op">$</span>cache_directory) ## unzip this file</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">shape &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/maptools/topics/readShapePoly">readShapePoly</a></span>(<span class="kw">file.path</span>(<span class="kw"><a href="../reference/ala_config.html">ala_config</a></span>()<span class="op">$</span>cache_directory, <span class="st">"CONSERVATION_NpwsaReserves.shp"</span>))</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">## extract just the Morialta Conservation Park polygon</a>
<a class="sourceLine" id="cb25-6" data-line-number="6">shape &lt;-<span class="st"> </span>shape[shape<span class="op">$</span>RESNAME<span class="op">==</span><span class="st">"Morialta"</span>,]</a></code></pre></div>
<p>We could create the WKT string using the <code>rgeos</code> library:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">library</span>(rgeos)</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">wkt &lt;-<span class="st"> </span><span class="kw">writeWKT</span>(shape)</a></code></pre></div>
<p>Unfortunately, in this instance this gives a WKT string that is too long and won’t be accepted by the ALA web service. Instead, let’s construct the WKT string directly, which gives us a little more control over its format:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">lonlat &lt;-<span class="st"> </span>shape<span class="op">@</span>polygons[[<span class="dv">1</span>]]<span class="op">@</span>Polygons[[<span class="dv">1</span>]]<span class="op">@</span>coords ## extract the polygon coordinates</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">## extract the convex hull of the polygon to reduce the length of the WKT string</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">temp &lt;-<span class="st"> </span><span class="kw">chull</span>(lonlat)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">lonlat &lt;-<span class="st"> </span>lonlat[<span class="kw">c</span>(temp,temp[<span class="dv">1</span>]),]</a>
<a class="sourceLine" id="cb27-5" data-line-number="5">## create WKT string</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">wkt &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">"POLYGON(("</span>,<span class="kw">paste</span>(<span class="kw">apply</span>(lonlat,<span class="dv">1</span>,<span class="cf">function</span>(z) <span class="kw">paste</span>(z,<span class="dt">collapse=</span><span class="st">" "</span>)),<span class="dt">collapse=</span><span class="st">","</span>),<span class="st">"))"</span>,<span class="dt">sep=</span><span class="st">""</span>)</a></code></pre></div>
<p>Now extract the species list in this polygon, filtering to only include those with a conservation status:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/specieslist.html">specieslist</a></span>(<span class="dt">wkt=</span>wkt,<span class="dt">fq=</span><span class="st">"state_conservation:*"</span>)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">(<span class="kw">head</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/arrange">arrange</a></span>(x,<span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/desc">desc</a></span>(occurrenceCount)),<span class="dv">20</span>))</a></code></pre></div>
<pre><code>##                                                               taxonConceptLsid
## 1  urn:lsid:biodiversity.org.au:afd.taxon:72ca8d75-71da-4751-a5cf-aa07ac3869f7
## 2  urn:lsid:biodiversity.org.au:afd.taxon:dc90876f-838c-4686-a353-75a3e25d2e1b
## 3                              http://id.biodiversity.org.au/node/apni/2896820
## 4  urn:lsid:biodiversity.org.au:afd.taxon:364d0d4b-e986-45af-b5da-bb372a3ad39c
## 5                              http://id.biodiversity.org.au/node/apni/8489762
## 6                              http://id.biodiversity.org.au/node/apni/2919415
## 7                              http://id.biodiversity.org.au/node/apni/2891764
## 8  urn:lsid:biodiversity.org.au:afd.taxon:01502fec-31f9-4e83-b827-5de8b113fb5f
## 9  urn:lsid:biodiversity.org.au:afd.taxon:31450840-9baf-4581-a5db-ab50ee5a8f93
## 10                              http://id.biodiversity.org.au/name/apni/106077
## 11                             http://id.biodiversity.org.au/node/apni/2918729
## 12 urn:lsid:biodiversity.org.au:afd.taxon:00b1b9a2-70c9-45be-8019-9c7fd755afc8
## 13 urn:lsid:biodiversity.org.au:afd.taxon:a581c303-95b9-4e2f-8fdc-103e394dd85f
## 14 urn:lsid:biodiversity.org.au:afd.taxon:290cabdd-2bd5-42a6-adea-f22341edea71
## 15 urn:lsid:biodiversity.org.au:afd.taxon:3293a0b2-c691-4e3e-b8ed-c639a24d0da5
## 16                             http://id.biodiversity.org.au/node/apni/2899781
## 17                             http://id.biodiversity.org.au/node/apni/2916843
## 18                             http://id.biodiversity.org.au/node/apni/2919200
## 19                             http://id.biodiversity.org.au/node/apni/2898209
## 20                             http://id.biodiversity.org.au/node/apni/2886348
##                              speciesName
## 1       Calyptorhynchus (Zanda) funereus
## 2           Hylacola pyrrhopygia parkeri
## 3                 Eucalyptus fasciculosa
## 4          Falco (Hierofalco) peregrinus
## 5                  Spyridium spathulatum
## 6               Anthocercis angustifolia
## 7              Austrostipa multispiculis
## 8              Isoodon obesulus obesulus
## 9                    Egernia cunninghami
## 10                Prasophyllum pruinosum
## 11         Correa glabra var. leucoclada
## 12                 Trichosurus vulpecula
## 13                   Antechinus flavipes
## 14                 Pseudophryne bibronii
## 15                 Falcunculus frontatus
## 16 Eucalyptus viminalis subsp. viminalis
## 17                         Todea barbara
## 18                     Acacia iteaphylla
## 19                 Prasophyllum pallidum
## 20                         Poa umbricola
##                scientificNameAuthorship       rank  kingdom     phylum
## 1                          (Shaw, 1794)    species ANIMALIA   CHORDATA
## 2               (Schodde &amp; Mason, 1999) subspecies ANIMALIA   CHORDATA
## 3                              F.Muell.    species  Plantae Charophyta
## 4                        Tunstall, 1771    species ANIMALIA   CHORDATA
## 5                     (F.Muell.) Benth.    species  Plantae Charophyta
## 6                              F.Muell.    species  Plantae Charophyta
## 7  (J.M.Black) S.W.L.Jacobs &amp; J.Everett    species  Plantae Charophyta
## 8                          (Shaw, 1797) subspecies ANIMALIA   CHORDATA
## 9                          (Gray, 1832)    species ANIMALIA   CHORDATA
## 10                                         species                    
## 11               (Lindl.) Paul G.Wilson    variety  Plantae Charophyta
## 12                         (Kerr, 1792)    species ANIMALIA   CHORDATA
## 13                   (Waterhouse, 1838)    species ANIMALIA   CHORDATA
## 14                        Günther, 1858    species ANIMALIA   CHORDATA
## 15                       (Latham, 1801)    species ANIMALIA   CHORDATA
## 16                                      subspecies  Plantae Charophyta
## 17                         (L.) T.Moore    species  Plantae Charophyta
## 18                   F.Muell. ex Benth.    species  Plantae Charophyta
## 19                             Nicholls    species  Plantae Charophyta
## 20                              Vickery    species  Plantae Charophyta
##            class           order          family           genus
## 1           AVES  PSITTACIFORMES      CACATUIDAE Calyptorhynchus
## 2           AVES   PASSERIFORMES    ACANTHIZIDAE        Hylacola
## 3  Equisetopsida        Myrtales       Myrtaceae      Eucalyptus
## 4           AVES   FALCONIFORMES      FALCONIDAE           Falco
## 5  Equisetopsida         Rosales      Rhamnaceae       Spyridium
## 6  Equisetopsida       Solanales      Solanaceae     Anthocercis
## 7  Equisetopsida          Poales         Poaceae     Austrostipa
## 8       MAMMALIA PERAMELEMORPHIA     PERAMELIDAE         Isoodon
## 9       REPTILIA        SQUAMATA       SCINCIDAE         Egernia
## 10                                                              
## 11 Equisetopsida      Sapindales        Rutaceae          Correa
## 12      MAMMALIA   DIPROTODONTIA   PHALANGERIDAE     Trichosurus
## 13      MAMMALIA  DASYUROMORPHIA      DASYURIDAE      Antechinus
## 14      AMPHIBIA           ANURA  MYOBATRACHIDAE    Pseudophryne
## 15          AVES   PASSERIFORMES PACHYCEPHALIDAE     Falcunculus
## 16 Equisetopsida        Myrtales       Myrtaceae      Eucalyptus
## 17 Equisetopsida      Osmundales     Osmundaceae           Todea
## 18 Equisetopsida         Fabales        Fabaceae          Acacia
## 19 Equisetopsida     Asparagales     Orchidaceae    Prasophyllum
## 20 Equisetopsida          Poales         Poaceae             Poa
##                      commonName occurrenceCount
## 1  Yellow-Tailed Black-Cockatoo             356
## 2                                            58
## 3                      Hill Gum              54
## 4              Peregrine Falcon              53
## 5          Spoon-Leaf Spyridium              39
## 6        Narrow-Leaf Ray-Flower              30
## 7     Many-Flowered Spear-Grass              21
## 8                                            21
## 9            Cunningham's Skink              19
## 10                                           14
## 11                  Rock Correa              14
## 12  Australian Brushtail Possum              14
## 13     Yellow-Footed Antechinus              14
## 14                Brown Toadlet              12
## 15           Crested Shrike-Tit              11
## 16                   Ribbon Gum               9
## 17                   Hard Todea               8
## 18        Flinders Range Wattle               8
## 19                                            7
## 20          Shade Tussock-Grass               6</code></pre>
</div>
<div id="example-3-quality-assertions" class="section level3">
<h3 class="hasAnchor">
<a href="#example-3-quality-assertions" class="anchor"></a>Example 3: Quality assertions</h3>
<p>Data quality assertions are a suite of fields that are the result of a set of tests peformed on ALA data. Download occurrence data for the golden bowerbird:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/occurrences.html">occurrences</a></span>(<span class="dt">taxon=</span><span class="st">"taxon_name:</span><span class="ch">\"</span><span class="st">Amblyornis newtonianus</span><span class="ch">\"</span><span class="st">"</span>, <span class="dt">download_reason_id=</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="kw">summary</span>(x)</a></code></pre></div>
<pre><code>## number of original names: 7 
## number of taxonomically corrected names: 1 
## number of observation records: 1580 
## number of assertions listed: 18  -- ones with flagged issues are listed below
##  invalidCollectionDate: 110 records 
##  incompleteCollectionDate: 150 records 
##  firstOfCentury: 8 records 
##  detectedOutlier: 4 records -- considered fatal
##  uncertaintyRangeMismatch: 17 records 
##  firstOfYear: 39 records 
##  altitudeInFeet: 2 records 
##  geodeticDatumAssumedWgs84: 780 records 
##  decimalLatLongConverted: 5 records 
##  unrecognisedOccurrenceStatus: 1 records 
##  coordinatePrecisionMismatch: 55 records 
##  countryInferredByCoordinates: 483 records 
##  assumedPresentOccurrenceStatus: 689 records 
##  unrecognizedGeodeticDatum: 105 records 
##  inferredDuplicateRecord: 101 records 
##  stateCoordinateMismatch: 1 records 
##  habitatMismatch: 14 records -- considered fatal
##  firstOfMonth: 97 records</code></pre>
<p>You can see that some of the points have assertions that are considered “fatal” (i.e. the occurrence record in question is unlikely to be suitable for subsequent analysis). We can use the <code>occurrences_plot</code> function to create a PDF file with a plot of this data, showing the points with fatal assertions (this will create an “Rplots.pdf” file in your working directory; not run here):</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw"><a href="../reference/occurrences_plot.html">occurrences_plot</a></span>(x,<span class="dt">qa=</span><span class="st">"fatal"</span>)</a></code></pre></div>
<p>There are many other ways of producing spatial plots in R. The <code>leaflet</code> package provides a simple method of producing browser-based maps iwth panning, zooming, and background layers:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">library</span>(leaflet)</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">## drop any records with missing lat/lon values</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">x<span class="op">$</span>data &lt;-<span class="st"> </span>x<span class="op">$</span>data[<span class="op">!</span><span class="kw">is.na</span>(x<span class="op">$</span>data<span class="op">$</span>longitude) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(x<span class="op">$</span>data<span class="op">$</span>latitude),]</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">xa &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check_assertions.html">check_assertions</a></span>(x)</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">## columns of x corresponding to a fatal assertion</a>
<a class="sourceLine" id="cb33-6" data-line-number="6">x_afcols &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">names</span>(x<span class="op">$</span>data) <span class="op">%in%</span><span class="st"> </span>xa<span class="op">$</span>occurColnames[xa<span class="op">$</span>fatal])</a>
<a class="sourceLine" id="cb33-7" data-line-number="7">## rows of x that have a fatal assertion</a>
<a class="sourceLine" id="cb33-8" data-line-number="8">x_afrows &lt;-<span class="st"> </span><span class="kw">apply</span>(x<span class="op">$</span>data[,x_afcols],<span class="dv">1</span>,any)</a>
<a class="sourceLine" id="cb33-9" data-line-number="9">## which fatal assertions are present in this data?</a>
<a class="sourceLine" id="cb33-10" data-line-number="10">these_assertions &lt;-<span class="st"> </span><span class="kw">names</span>(x<span class="op">$</span>data)[x_afcols]</a>
<a class="sourceLine" id="cb33-11" data-line-number="11">## make a link to th web page for each occurrence</a>
<a class="sourceLine" id="cb33-12" data-line-number="12">popup_link &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"&lt;a href=</span><span class="ch">\"</span><span class="st">http://biocache.ala.org.au/occurrences/"</span>,x<span class="op">$</span>data<span class="op">$</span>id,<span class="st">"</span><span class="ch">\"</span><span class="st">&gt;Link to occurrence record&lt;/a&gt;"</span>)</a>
<a class="sourceLine" id="cb33-13" data-line-number="13">## colour palette</a>
<a class="sourceLine" id="cb33-14" data-line-number="14">pal &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">sub</span>(<span class="st">"FF$"</span>,<span class="st">""</span>,<span class="kw">heat.colors</span>(<span class="kw">length</span>(these_assertions))))</a>
<a class="sourceLine" id="cb33-15" data-line-number="15">## map each data row to colour, depending on its assertions</a>
<a class="sourceLine" id="cb33-16" data-line-number="16">marker_colour &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">"#00FF00"</span>,<span class="kw">nrow</span>(x<span class="op">$</span>data))</a>
<a class="sourceLine" id="cb33-17" data-line-number="17"><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(these_assertions)) marker_colour[x<span class="op">$</span>data[,x_afcols[k]]] &lt;-<span class="st"> </span>pal[k]</a>
<a class="sourceLine" id="cb33-18" data-line-number="18">## blank map, with imagery background</a>
<a class="sourceLine" id="cb33-19" data-line-number="19">m &lt;-<span class="st"> </span><span class="kw">addProviderTiles</span>(<span class="kw">leaflet</span>(),<span class="st">"Esri.WorldImagery"</span>)</a>
<a class="sourceLine" id="cb33-20" data-line-number="20">## add markers</a>
<a class="sourceLine" id="cb33-21" data-line-number="21">m &lt;-<span class="st"> </span><span class="kw">addCircleMarkers</span>(m,x<span class="op">$</span>data<span class="op">$</span>longitude,x<span class="op">$</span>data<span class="op">$</span>latitude,<span class="dt">col=</span>marker_colour,<span class="dt">popup=</span>popup_link)</a>
<a class="sourceLine" id="cb33-22" data-line-number="22"><span class="kw">print</span>(m)</a></code></pre></div>
</div>
<div id="example-4-community-composition-and-turnover" class="section level3">
<h3 class="hasAnchor">
<a href="#example-4-community-composition-and-turnover" class="anchor"></a>Example 4: Community composition and turnover</h3>
<p>Some extra packages needed here:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw">library</span>(vegan)</a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="kw">library</span>(mgcv)</a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="kw">library</span>(geosphere)</a></code></pre></div>
<p>Define our area of interest as a transect running westwards from the Sydney region, and download the occurrences of legumes (Fabaceae; a large family of flowering plants) in this area:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">wkt &lt;-<span class="st"> "POLYGON((152.5 -35,152.5 -32,140 -32,140 -35,152.5 -35))"</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/occurrences.html">occurrences</a></span>(<span class="dt">taxon=</span><span class="st">"family:Fabaceae"</span>,<span class="dt">wkt=</span>wkt,<span class="dt">qa=</span><span class="st">"none"</span>,<span class="dt">download_reason_id=</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">x &lt;-<span class="st"> </span>x<span class="op">$</span>data ## just take the data component</a></code></pre></div>
<p>Bin the locations into 0.5-degree grid cells:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">x<span class="op">$</span>longitude &lt;-<span class="st"> </span><span class="kw">round</span>(x<span class="op">$</span>longitude<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2">x<span class="op">$</span>latitude &lt;-<span class="st"> </span><span class="kw">round</span>(x<span class="op">$</span>latitude<span class="op">*</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span></a></code></pre></div>
<p>Create a sites-by-species data frame. This could also be done with e.g. the reshape library or the table() function, or indeed directly from ALA4R’s <code>species_by_site</code> function. Note: this process inherently makes some strong assumptions about <em>absences</em> in the data.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">## discard genus- and higher-level records</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">xsub &lt;-<span class="st"> </span>x<span class="op">$</span>rank <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"species"</span>,<span class="st">"subspecies"</span>,<span class="st">"variety"</span>,<span class="st">"form"</span>,<span class="st">"cultivar"</span>)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">unames &lt;-<span class="st"> </span><span class="kw">unique</span>(x[xsub,]<span class="op">$</span>scientificName) ## unique names</a>
<a class="sourceLine" id="cb37-4" data-line-number="4">ull &lt;-<span class="st"> </span><span class="kw">unique</span>(x[xsub,<span class="kw">c</span>(<span class="st">"longitude"</span>,<span class="st">"latitude"</span>)])</a>
<a class="sourceLine" id="cb37-5" data-line-number="5">xgridded &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">nrow</span>(ull),<span class="dt">ncol=</span><span class="kw">length</span>(unames))</a>
<a class="sourceLine" id="cb37-6" data-line-number="6"><span class="cf">for</span> (uli <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(ull)) {</a>
<a class="sourceLine" id="cb37-7" data-line-number="7">    lidx &lt;-<span class="st"> </span>xsub <span class="op">&amp;</span><span class="st"> </span>x<span class="op">$</span>longitude<span class="op">==</span>ull[uli,]<span class="op">$</span>longitude <span class="op">&amp;</span><span class="st"> </span>x<span class="op">$</span>latitude<span class="op">==</span>ull[uli,]<span class="op">$</span>latitude</a>
<a class="sourceLine" id="cb37-8" data-line-number="8">    xgridded[uli,] &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(unames <span class="op">%in%</span><span class="st"> </span>x[lidx,]<span class="op">$</span>scientificName)</a>
<a class="sourceLine" id="cb37-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb37-10" data-line-number="10">xgridded &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(xgridded)</a>
<a class="sourceLine" id="cb37-11" data-line-number="11"><span class="kw">names</span>(xgridded) &lt;-<span class="st"> </span>unames</a>
<a class="sourceLine" id="cb37-12" data-line-number="12">xgridded &lt;-<span class="st"> </span><span class="kw">cbind</span>(ull,xgridded)</a></code></pre></div>
<p>Now we can start to examine the patterns in the data. Let’s plot richness as a function of longitude:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="kw">plot</span>(xgridded<span class="op">$</span>longitude,<span class="kw">apply</span>(xgridded[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)],<span class="dv">1</span>,sum),<span class="dt">ylab=</span><span class="st">"Richness"</span>,</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">  <span class="dt">xlab=</span><span class="st">"Longitude"</span>,<span class="dt">pch=</span><span class="dv">20</span>,<span class="dt">col=</span><span class="st">"grey25"</span>)</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-37-1.png" width="700" style="display:block; margin: auto"></p>
<p>The number of species is highest at the eastern end of the transect (the Sydney/Blue Mountains area). This probably reflects both higher species richness as well as greater sampling effort in this area compared to the western end of the transect.</p>
<p>How does the community composition change along the transect? Calculate the dissimilarity between nearby grid cells as a function of along-transect position:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">D &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/vegan/topics/vegdist">vegdist</a></span>(xgridded[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)],<span class="st">'bray'</span>) ## Bray-Curtis dissimilarity</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">Dm &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(D) ## convert to a matrix object</a>
<a class="sourceLine" id="cb39-3" data-line-number="3">## calculate geographic distance from longitude and latitude</a>
<a class="sourceLine" id="cb39-4" data-line-number="4">Dll &lt;-<span class="st"> </span><span class="kw">apply</span>(xgridded[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>],<span class="dv">1</span>,<span class="cf">function</span>(z){<span class="kw"><a href="http://www.rdocumentation.org/packages/geosphere/topics/distVincentySphere">distVincentySphere</a></span>(z,xgridded[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>])})</a>
<a class="sourceLine" id="cb39-5" data-line-number="5">closeidx &lt;-<span class="st"> </span>Dll<span class="op">&gt;</span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>Dll<span class="op">&lt;</span><span class="fl">100e3</span> ## find grid cells within 100km of each other</a>
<a class="sourceLine" id="cb39-6" data-line-number="6">## create a matrix of longitudes that matches the size of the pairwise-D matrices</a>
<a class="sourceLine" id="cb39-7" data-line-number="7">temp &lt;-<span class="st"> </span><span class="kw">matrix</span>(xgridded<span class="op">$</span>longitude,<span class="dt">nrow=</span><span class="kw">nrow</span>(xgridded),<span class="dt">ncol=</span><span class="kw">nrow</span>(xgridded))</a>
<a class="sourceLine" id="cb39-8" data-line-number="8">## plot dissimilarity as a function of transect position</a>
<a class="sourceLine" id="cb39-9" data-line-number="9"><span class="kw">plot</span>(temp[closeidx],Dm[closeidx],<span class="dt">xlab=</span><span class="st">"Longitude"</span>,<span class="dt">ylab=</span><span class="st">"Dissimilarity"</span>,<span class="dt">pch=</span><span class="dv">20</span>,<span class="dt">col=</span><span class="st">"grey85"</span>)</a>
<a class="sourceLine" id="cb39-10" data-line-number="10">## add smooth fit via gam()</a>
<a class="sourceLine" id="cb39-11" data-line-number="11">fit &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/mgcv/topics/gam">gam</a></span>(d<span class="op">~</span><span class="kw"><a href="http://www.rdocumentation.org/packages/mgcv/topics/s">s</a></span>(tp,<span class="dt">k=</span><span class="dv">7</span>),<span class="dt">data=</span><span class="kw">data.frame</span>(<span class="dt">tp=</span>temp[closeidx],<span class="dt">d=</span>Dm[closeidx]))</a>
<a class="sourceLine" id="cb39-12" data-line-number="12">tpp &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from=</span><span class="kw">min</span>(xgridded<span class="op">$</span>longitude),<span class="dt">to=</span><span class="kw">max</span>(xgridded<span class="op">$</span>longitude),<span class="dt">length.out=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb39-13" data-line-number="13">fitp &lt;-<span class="st"> </span><span class="kw">predict</span>(fit,<span class="dt">newdata=</span><span class="kw">data.frame</span>(<span class="dt">tp=</span>tpp))</a>
<a class="sourceLine" id="cb39-14" data-line-number="14"><span class="kw">lines</span>(tpp,fitp,<span class="dt">col=</span><span class="dv">1</span>)</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-38-1.png" width="700" style="display:block; margin: auto"></p>
<p>Clustering:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">cl &lt;-<span class="st"> </span><span class="kw">hclust</span>(D,<span class="dt">method=</span><span class="st">"ave"</span>) ## UPGMA clustering</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="kw">plot</span>(cl) ## plot dendrogram</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-39-1.png" width="576" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">grp &lt;-<span class="st"> </span><span class="kw">cutree</span>(cl,<span class="dv">20</span>) ## extract group labels at the 20-group level</a>
<a class="sourceLine" id="cb41-2" data-line-number="2">## coalesce small (outlier) groups into a single catch-all group</a>
<a class="sourceLine" id="cb41-3" data-line-number="3">sing &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">table</span>(grp)<span class="op">&lt;</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb41-4" data-line-number="4">grp[grp <span class="op">%in%</span><span class="st"> </span>sing] &lt;-<span class="st"> </span><span class="dv">21</span> ## put these in a new combined group</a>
<a class="sourceLine" id="cb41-5" data-line-number="5">grp &lt;-<span class="st"> </span><span class="kw">sapply</span>(grp,<span class="cf">function</span>(z)<span class="kw">which</span>(<span class="kw">unique</span>(grp)<span class="op">==</span>z)) ## renumber groups</a>
<a class="sourceLine" id="cb41-6" data-line-number="6">## plot</a>
<a class="sourceLine" id="cb41-7" data-line-number="7"><span class="kw">with</span>(xgridded,<span class="kw">plot</span>(longitude,latitude,<span class="dt">pch=</span><span class="dv">21</span>,<span class="dt">col=</span>grp,<span class="dt">bg=</span>grp))</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-39-2.png" width="576" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">## or slightly nicer map plot</a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="kw">library</span>(maps)</a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="kw">library</span>(mapdata)</a>
<a class="sourceLine" id="cb42-4" data-line-number="4"><span class="kw"><a href="http://www.rdocumentation.org/packages/maps/topics/map">map</a></span>(<span class="st">"worldHires"</span>,<span class="st">"Australia"</span>, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">105</span>,<span class="dv">155</span>), <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">45</span>,<span class="op">-</span><span class="dv">10</span>), <span class="dt">col=</span><span class="st">"gray90"</span>, <span class="dt">fill=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb42-5" data-line-number="5">thiscol &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#1f77b4"</span>,<span class="st">"#ff7f0e"</span>,<span class="st">"#2ca02c"</span>,<span class="st">"#d62728"</span>,<span class="st">"#9467bd"</span>,<span class="st">"#8c564b"</span>,<span class="st">"#e377c2"</span>,<span class="st">"#7f7f7f"</span>,<span class="st">"#bcbd22"</span>,<span class="st">"#17becf"</span>) ## colours for clusters</a>
<a class="sourceLine" id="cb42-6" data-line-number="6"><span class="kw">with</span>(xgridded,<span class="kw">points</span>(longitude,latitude,<span class="dt">pch=</span><span class="dv">21</span>,<span class="dt">col=</span>thiscol[grp],<span class="dt">bg=</span>thiscol[grp],<span class="dt">cex=</span><span class="fl">0.75</span>))</a></code></pre></div>
<p><img src="ALA4R_files/figure-html/unnamed-chunk-39-3.png" width="576" style="display:block; margin: auto"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#ala4r">ALA4R</a><ul class="nav nav-pills nav-stacked">
<li><a href="#installing-ala4r">Installing ALA4R</a></li>
      <li><a href="#using-ala4r">Using ALA4R</a></li>
      <li><a href="#customizing">Customizing</a></li>
      <li><a href="#example-usage">Example usage</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ben Raymond, Jeremy VanDerWal, Lee Belbin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
