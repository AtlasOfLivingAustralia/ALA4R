---
title: "Introduction to ALA4R v2"
author: "Matilda Stevenson"
date: '`r Sys.Date()`'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ALA4R v2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# ALA4R

```{r setup, include=FALSE}
library(knitr)
options(width=120)
```

The Atlas of Living Australia (ALA) provides tools to enable users of biodiversity information to find, access, combine and visualise data on Australian plants and animals; these have been made available from https://www.ala.org.au/. Here we provide a subset of the tools to be directly used within R.

ALA4R enables the R community to directly access data and resources hosted by the ALA. 

## Installing ALA4R

Stable version from CRAN:

```{r eval=FALSE}
install.packages("ALA4R")
```

Or the development version from GitHub:

```{r eval=FALSE}
install.packages("devtools")
devtools::install_github("AtlasOfLivingAustralia/ALA4R@dev")
```

On Linux you will first need to ensure that `libcurl` and `v8` (version <= 3.15) are installed on your system --- e.g. on Ubuntu/Debian, open a terminal and do:

```{sh eval=FALSE}
sudo apt-get install libcurl4-openssl-dev libv8-3.14-dev
```
or install via the Software Centre.


## Using ALA4R

The ALA4R package must be loaded for each new R session:

```{r}
library(ALA4R)
```

## Customizing

Various aspects of the ALA4R package can be customized.

### Caching
ALA4R can cache most results to local files. This means that if the same code is run multiple times, the second and subsequent iterations will be faster. This will also reduce load on the ALA servers.

By default, this caching is session-based, meaning that the local files are stored in a temporary directory that is automatically deleted when the R session is ended. This behaviour can be altered so that caching is permanent, by setting the caching directory to a non-temporary location. For example, under Windows, use something like:

```{r eval=FALSE}
ala_config(cache_directory="c:/mydata/ala_cache") ## use forward slashes, not \
```

or for Linux:

```{r eval=FALSE}
ala_config(cache_directory="~/mydata/ala_cache")
```

Note that this directory must exist (you need to create it yourself).


All results will be stored in that cache directory and will be used from one session to the next. They won't be re-downloaded from the server unless the user specifically deletes those files or changes the caching setting to "refresh".

If you change the cache_directory to a permanent location, you may wish to add something like this to your .Rprofile file, so that it happens automatically each time the ALA4R package is loaded:

```{r eval=FALSE}
setHook(packageEvent("ALA4R", "attach"), function(...)
    ala_config(cache_directory=file.path("~", "mydata", "ala_cache")))
```

Caching can also be turned off entirely by:

```{r eval=FALSE}
ala_config(caching="off")
```

or set to "refresh", meaning that the cached results will re-downloaded from the ALA servers and the cache updated. (This will happen for as long as caching is set to "refresh" --- so you may wish to switch back to normal "on" caching behaviour once you have updated your cache with the data you are working on).

```{r}
Sys.setenv(ala_email = "ala4r@ala.org.au")
```

### User-agent string
Each request to the ALA servers is accompanied by a "user-agent" string that identifies the software making the request. This is a standard behaviour used by web browsers as well. The user-agent identifies the user requests to the ALA, helping the ALA to adapt and enhance the services that it provides. By default, the ALA4R user-agent string is set to "ALA4R" plus the ALA4R version number (e.g. "ALA4R 1.5.2").

*NO* personal identification information is sent. You can see all configuration settings, including the the user-agent string that is being used, with the command:

```{r eval=FALSE}
ala_config()
```

### Debugging
If things aren't working as expected, more detail (particularly about web requests and caching behaviour) can be obtained by setting the `verbose` configuration option:

```{r eval=FALSE}
ala_config(verbose=TRUE)
```

### Setting the download reason
ALA requires that you provide a reason when downloading occurrence data (via the ALA4R `occurrences()` function). You can provide this as a parameter directly to each call of `occurrences()`, or you can set it once per session using:

```{r eval=FALSE}
ala_config(download_reason_id=your_reason_id)
```

(See `ala_reasons()` for valid download reasons)


### Other options
If you make a request that returns an empty result set (e.g. an un-matched name), by default you will simply get an empty data structure returned to you without any special notification. If you would like to be warned about empty result sets, you can use:

```{r eval=FALSE}
ala_config(warn_on_empty=TRUE)
```

## Example usage

First, check that we have some additional packages that we'll use in the examples, and install them if necessary.
```{r message=FALSE}
to_install <- c("dplyr", "ggplot2", "ozmaps", "sf")
to_install <- to_install[!sapply(to_install, requireNamespace, quietly=TRUE)]
if(length(to_install)>0)
    install.packages(to_install, repos="http://cran.us.r-project.org")

## In these examples we use the `dplyr` package to help with data manipulation.
library(dplyr)
library(ggplot2)
library(ozmaps)
library(sf)
library(ALA4R)
library(knitr)
```

## Taxon information
Retrieve information for a taxon or taxa. For each taxon, provide a rank, multiple ranks, or an ALA taxon id.

The `taxon_concept_id` column can be used as the `taxon_id` parameter in other functions. 
```{r}
# A single taxa
quoll <- ala_taxa("Dasyurus viverrinus")
quoll
```

Optionally include record counts for a species, and child concepts of the supplied species
```{r}
banksia <- ala_taxa(list(genus = "Banksia"), return_children = TRUE, include_counts = TRUE)

# Select only the species-level taxa, sort by count, and display the top 5
top5_banksia <- banksia %>% filter(rank == "species") %>%
  arrange(desc(count)) %>%
  select(scientific_name, taxon_concept_id, count) %>%
  head(n = 5)

top5_banksia

```


Lookup a taxon id
```{r}
id <- "urn:lsid:biodiversity.org.au:afd.taxon:d315deea-822c-4f2c-b439-da33d6af5fd6"
ala_taxa(term = id, term_type = "identifier")
```

## Occurrence data
Download occurrence data for a taxon
```{r, message=FALSE}
ala_config(email = "ala4r@ala.org.au")
```

```{r eval = FALSE}
occ <- ala_occurrences(taxon_id = quoll)
```

```{r include = FALSE}
occ <- read.csv("dasyurus_viverrinus.csv")
```

```{r}
head(occ)
```

Plot occurrence data using ggplot

```{r eval = FALSE}
# build filters and columns
cols <- ala_columns(group = "basic", extra = "country")
filters <- ala_filters(list(year = seq(2000, 2020)))
occ <- ala_occurrences(taxon_id = top5_banksia,
                       columns = cols, filters = filters)
```

```{r include = FALSE}
occ <- read.csv("banksia.csv")
```

```{r}
filtered_occ <- occ %>% filter(country == "Australia")
head(filtered_occ)
```


```{r warning=FALSE, out.width="100%", fig.width=100, eval = FALSE}
ggplot() + geom_sf(data = ozmap_country) +
  geom_point(filtered_occ, mapping = aes(x = decimalLongitude, y = decimalLatitude,
                                         colour = species),size = .3)

```


## Customising searches
Occurrence searches can be narrowed down by area, a variety of filters, and data quality tests. 
```{r eval=FALSE, message=FALSE, warning=FALSE}
# Find all reptiles within a shapefile
id <- ala_taxa("Ornithorhynchus anatinus")
simple_shp <- st_cast(st_read('act_rect.shp'), "MULTIPOLYGON")

occ <- ala_occurrences(taxon_id = id, geometry = ala_geometry(area = simple_shp))
```

```{r include = FALSE}
occ <- read.csv("ornithorhynchus_anatinus.csv")
simple_shp <- st_cast(st_read('act_rect.shp'), "MULTIPOLYGON")
```

```{r}
ggplot() + geom_sf(data = simple_shp) +
  geom_point(data = occ, mapping = aes(x = decimalLongitude, y = decimalLatitude))

```

### Environmental layers
```{r}
# Get all layers relating to precipitation
layers <- ala_layers()
layers[grepl("precipitation", tolower(layers$description)),]$display_name

```

### Fields and categories


### Data quality profile
By default, the data quality profile is set to the ALA general.
```{r}
# List available data quality profiles
ala_data_profiles()

# List filters for a profile
ala_quality_filters("CSDM")
```

## Summary statistics
```{r}
# Total number of records in the ALA (with no data quality filters)
ala_counts()

# Total number of records, broken down by kindgom
ala_counts(breakdown = "kingdom")
```

## Species checklists
Checklists are lists of species in the ALA matching a set of filters Run `ala_checklist()` with no arguments to retrieve a list
of all species in the ALA. 
```{r message=FALSE}
# Varanus species in NT and NSW
id <- ala_taxa("Varanus")
nt_sp <- ala_checklist(id, filters = ala_filters(list(state = 'Northern Territory'))) %>%
  arrange(species_name) %>% pull(species_name)
nsw_sp <- ala_checklist(id, filters = ala_filters(list(state = 'New South Wales'))) %>%
  arrange(species_name) %>% pull(species_name)

# Species found in both states
intersect(nsw_sp, nt_sp)
```



## Media downloads
```{r warning=FALSE, message=FALSE, eval = FALSE}
# Search for occurrences with images
filters <- ala_filters(list("multimedia" = "Image",
                                      basis_of_record = "HumanObservation"))
occ <- ala_occurrences(quoll$taxon_concept_id,
                       filters = filters)
images <- ala_media(head(occ$recordID, n = 5), download_dir = 'data/',
                    identifier_type = "occurrence")

# filter by licence type
images %>% filter(recognisedLicence == "CC BY-NC 4.0")
```

